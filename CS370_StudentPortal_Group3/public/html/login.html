<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>CS College - Login</title>
  <link rel="stylesheet" href="../css/main.css" />
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
</head>
<body class="login-body">

<!-- Snow Animation Background -->
<div class="snow-container">
  <div class="snowfall"></div>
  <div class="snowflakes" aria-hidden="true">
    <!-- Snowflakes will be generated by JavaScript -->
  </div>





  <div class="snow-ground"></div>
</div>

<div class="login-container">
  <div class="login-header">
    <div class="logo">
      <i class="fas fa-graduation-cap fa-3x"></i>
      <h1>CS College</h1>
    </div>
    <h2>Student Information System</h2>
    <div class="weather-info">
      <i class="fas fa-snowflake"></i>
      <span>Fall/Winter Semester Login</span>
    </div>
  </div>

  <div class="login-card">
    <div id="loginAlert" class="alert" style="display: none;"></div>

    <div class="user-type">
      <label>
        <input type="radio" name="userType" value="student" checked>
        <span>Student</span>
      </label>
      <label>
        <input type="radio" name="userType" value="faculty">
        <span>Faculty</span>
      </label>
    </div>

    <div class="form-group">
      <label for="username">Username</label>
      <input type="text" id="username" class="form-control" placeholder="Enter username" />
    </div>

    <div class="form-group">
      <label for="password">Password</label>
      <input type="password" id="password" class="form-control" placeholder="Enter password" />
    </div>
    
    <div class="g-recaptcha" data-sitekey="6LciVyAsAAAAAB0hopn_A5JUKMFD6TfQSrlVBGMy"></div>

    <button id="loginBtn" class="btn btn-block">
      <i class="fas fa-sign-in-alt"></i> Login
    </button>
    
    <button class="btn btn-block" onclick="window.location.href='home.html'">
      <i class="fas fa-home"></i> Back to Home
    </button>

    <div class="snow-hint">
      <i class="fas fa-info-circle"></i>
      <small>It's snowing outside! Stay warm and secure your login.</small>
    </div>
  </div>

  <script src="https://www.google.com/recaptcha/api.js" async defer></script>

  <footer class="login-footer">
    <p>CS 370 Computer Security - Secure Web Application Project</p>
    <p class="snow-status"><i class="fas fa-snowflake"></i> Snow animation active</p>
  </footer>
</div>

<script src="../js/auth.js"></script>
<script src="../js/common.js"></script>

<script>
// Snow animation configuration
const SNOWFLAKE_COUNT = 75;
const SNOWFLAKE_SYMBOLS = ['❄', '❅', '❆', '✻', '✼', '✦'];
const SNOW_COLORS = ['#ffffff', '#f0f8ff', '#e6f7ff', '#f0ffff', '#f8f8ff'];

// Create snowflakes
function createSnowflakes() {
  const container = document.querySelector('.snowflakes');
  
  for (let i = 0; i < SNOWFLAKE_COUNT; i++) {
    const snowflake = document.createElement('div');
    snowflake.className = 'snowflake';
    
    // Random properties
    const size = Math.random() * 20 + 10; // 10-30px
    const startX = Math.random() * 100; // 0-100% horizontal position
    const animationDuration = Math.random() * 10 + 10; // 10-20 seconds
    const animationDelay = Math.random() * 5; // 0-5 seconds delay
    const opacity = Math.random() * 0.7 + 0.3; // 0.3-1 opacity
    const symbol = SNOWFLAKE_SYMBOLS[Math.floor(Math.random() * SNOWFLAKE_SYMBOLS.length)];
    const color = SNOW_COLORS[Math.floor(Math.random() * SNOW_COLORS.length)];
    const swayAmount = Math.random() * 50 + 20; // 20-70px horizontal sway
    
    // Apply styles
    snowflake.textContent = symbol;
    snowflake.style.cssText = `
      position: absolute;
      top: -30px;
      left: ${startX}%;
      font-size: ${size}px;
      color: ${color};
      opacity: ${opacity};
      animation: fall ${animationDuration}s linear ${animationDelay}s infinite,
                 sway ${animationDuration/3}s ease-in-out ${animationDelay}s infinite alternate;
      z-index: 1;
      user-select: none;
      pointer-events: none;
      text-shadow: 0 0 5px rgba(255, 255, 255, 0.5);
      filter: blur(${Math.random() * 0.5}px);
      transform: translateX(${Math.random() * 20 - 10}px);
    `;
    
    // Add subtle rotation for some snowflakes
    if (Math.random() > 0.5) {
      snowflake.style.animation += `, spin ${animationDuration * 2}s linear ${animationDelay}s infinite`;
    }
    
    container.appendChild(snowflake);
  }
}

// Add CSS for animations
function addSnowStyles() {
  const style = document.createElement('style');
  style.textContent = `
    @keyframes fall {
      0% {
        top: -30px;
        transform: translateX(0);
      }
      100% {
        top: 100vh;
        transform: translateX(${Math.random() * 100 - 50}px);
      }
    }
    
    @keyframes sway {
      0% {
        transform: translateX(0);
      }
      100% {
        transform: translateX(20px);
      }
    }
    
    @keyframes spin {
      0% {
        transform: rotate(0deg);
      }
      100% {
        transform: rotate(360deg);
      }
    }
    
    /* Snow accumulation on ground */
    @keyframes accumulate {
      0% {
        height: 0;
      }
      100% {
        height: 50px;
      }
    }
  `;
  document.head.appendChild(style);
}

// Initialize snow when page loads
document.addEventListener('DOMContentLoaded', function() {
  addSnowStyles();
  createSnowflakes();
  
  // Add some interactivity - snowflakes respond to mouse
  document.addEventListener('mousemove', function(e) {
    const snowflakes = document.querySelectorAll('.snowflake');
    const mouseX = e.clientX;
    const mouseY = e.clientY;
    
    snowflakes.forEach(flake => {
      const rect = flake.getBoundingClientRect();
      const flakeX = rect.left + rect.width / 2;
      const flakeY = rect.top + rect.height / 2;
      
      const distance = Math.sqrt(
        Math.pow(mouseX - flakeX, 2) + Math.pow(mouseY - flakeY, 2)
      );
      
      if (distance < 100) {
        const pushX = (flakeX - mouseX) / distance * 3;
        const pushY = (flakeY - mouseY) / distance * 3;
        
        flake.style.transform = `translate(${pushX}px, ${pushY}px)`;
      }
    });
  });
});


// otherwise provides a minimal fallback)
const alertEl = document.getElementById('loginAlert');
function showAlertFallback(el, message, type = 'info') {
  if (typeof showAlert === 'function') {
    
    showAlert(el, message, type);
    return;
  }
  el.style.display = 'block';
  el.textContent = message;
  el.style.color = type === 'error' ? '#8b0000' : '#064e3b';
  setTimeout(() => { el.style.display = 'none'; }, 4000);
}

document.getElementById('loginBtn').addEventListener('click', handleLogin);

async function handleLogin(e) {
  e?.preventDefault?.();

  const loginBtn = document.getElementById('loginBtn');
  const username = document.getElementById('username').value.trim();
  const password = document.getElementById('password').value;
  const userType = document.querySelector('input[name="userType"]:checked').value;

  // basic validation
  if (!username || !password) {
    showAlertFallback(alertEl, 'Please enter both username and password', 'error');
    return;
  }

  // ✅ CAPTCHA validation: get the token from reCAPTCHA
  const captchaResponse = grecaptcha.getResponse();
  if (!captchaResponse) {
    showAlertFallback(alertEl, 'Please complete the CAPTCHA', 'error');
    return;
  }

  // UI: disable button while request in progress
  loginBtn.disabled = true;
  loginBtn.innerHTML = '<i class="fas fa-spinner fa-spin"></i> Logging in...';

  try {
    const resp = await fetch('/api/login', {
      method: 'POST',
      headers: { 'Content-Type': 'application/json' },
      body: JSON.stringify({ 
        username, 
        password, 
        userType, 
        'g-recaptcha-response': captchaResponse // send CAPTCHA to server
      })
    });

    // Try parse JSON safely
    let data;
    try { data = await resp.json(); } catch (err) { data = {}; }

    if (!resp.ok) {
      // show server message if available
      showAlertFallback(alertEl, data.message || 'Login failed', 'error');
      grecaptcha.reset(); // reset CAPTCHA on failure
      loginBtn.disabled = false;
      loginBtn.innerHTML = '<i class="fas fa-sign-in-alt"></i> Login';
      return;
    }

    // success
    // data should be: { id, username, role }
    sessionStorage.setItem('currentUser', JSON.stringify(data));

    // redirect based on role (normalize)
    const role = (data.role || '').toLowerCase();
    if (role === 'student') {
      window.location.href = '/html/studentDashboard.html';
    } else if (role === 'faculty' || role === 'professor') {
      window.location.href = '/html/facultyDashboard.html';
    } else {
      // fallback to a generic dashboard
      window.location.href = '/html/home.html';
    }

  } catch (err) {
    console.error('Login request error:', err);
    showAlertFallback(alertEl, 'Server unreachable. Please try again later.', 'error');
    loginBtn.disabled = false;
    loginBtn.innerHTML = '<i class="fas fa-sign-in-alt"></i> Login';
  }
}
</script>

<script>
// If the user ever lands on the login page (including via Back button),
// force a logout so any existing session is killed.
window.addEventListener('pageshow', async function () {
  const current = sessionStorage.getItem('currentUser');
  if (current) {
    // Clear client-side login
    if (typeof logout === 'function') {
      logout();
    } else {
      sessionStorage.removeItem('currentUser');
    }

    
  }
});
</script>

</body>
</html>
